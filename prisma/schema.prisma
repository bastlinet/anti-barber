generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Branch {
  id               String   @id @default(uuid())
  name             String
  slug             String   @unique
  address          String
  city             String
  lat              Float?
  lng              Float?
  phone            String
  email            String
  timezone         String   @default("Europe/Prague")
  bookingBufferMin Int      @default(30) // min time before booking
  slotStepMin      Int      @default(30) // reservation grid step (e.g. 30min slots)
  maxDaysAhead     Int      @default(30) // how far in future customers can book
  allowPayOnSite   Boolean  @default(true)
  allowPayOnline   Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  services BranchService[]
  staff    Staff[]
  shifts   Shift[]
  breaks   Break[]
}

model Service {
  id          String   @id @default(uuid())
  name        String
  category    String // e.g. "Vlasy", "Vousy", "Komplet"
  durationMin Int
  description String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  branches BranchService[]
  staff    StaffService[]
}

model BranchService {
  branchId   String
  serviceId  String
  priceCents Int // price in lowest currency unit (e.g. haléře/cents)
  active     Boolean @default(true)
  branch     Branch  @relation(fields: [branchId], references: [id])
  service    Service @relation(fields: [serviceId], references: [id])


  @@id([branchId, serviceId])
}

model Staff {
  id        String   @id @default(uuid())
  branchId  String
  name      String
  email     String?  // for admin login later
  phone     String?
  active    Boolean  @default(true)
  avatarUrl String?
  
  branch    Branch   @relation(fields: [branchId], references: [id])
  services  StaffService[]
  shifts    Shift[]
  breaks    Break[]
  timeOff   TimeOff[]
}

model StaffService {
  staffId   String
  serviceId String
  active    Boolean @default(true) // Helper to temporarily disable service for stats
  staff     Staff   @relation(fields: [staffId], references: [id])
  service   Service @relation(fields: [serviceId], references: [id])

  @@id([staffId, serviceId])
}

model Shift {
  id        String   @id @default(uuid())
  staffId   String
  branchId  String // Denormalized for faster query
  startAt   DateTime // UTC
  endAt     DateTime // UTC
  
  staff     Staff    @relation(fields: [staffId], references: [id])
  branch    Branch   @relation(fields: [branchId], references: [id])

  @@index([staffId, startAt])
  @@index([branchId, startAt])
}

model Break {
  id        String   @id @default(uuid())
  staffId   String
  branchId  String
  startAt   DateTime // UTC
  endAt     DateTime // UTC
  
  staff     Staff    @relation(fields: [staffId], references: [id])
  branch    Branch   @relation(fields: [branchId], references: [id])
}

model TimeOff {
  id        String   @id @default(uuid())
  staffId   String
  startAt   DateTime // UTC
  endAt     DateTime // UTC
  reason    String?
  approved  Boolean  @default(true)
  
  staff     Staff    @relation(fields: [staffId], references: [id])
}
